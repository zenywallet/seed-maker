<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="js/jquery-3.4.1.slim.min.js"></script>
  <script type="text/javascript" src="js/jquery-qrcode.js"></script>
  <script type="text/javascript" src="js/base58.js"></script>
  <script type="text/javascript" src="js/jspdf.debug.js"></script>
  <script type="text/javascript" src="js/RobotoMono-Bold.js"></script>
  <title>Seed Maker</title>
</head>
<body>
<div id="qrcode"></div>
<div id="seed"></div>
<div>
<form name="form" action="#">
  <input id="printable" type="checkbox"> printable
</form>
<button id="btn-download-type1">Download PDF (layout 1)</button>
<button id="btn-download-type2">Download PDF (layout 2)</button>
</div>
<div>
<iframe id="pdf-preview" type="application/pdf" width="640" height="480"></iframe>
</div>
<script>
var preview_iframe = document.getElementById("pdf-preview");
preview_iframe.contentWindow.document.open();
preview_iframe.contentWindow.document.write('');
preview_iframe.contentWindow.document.close();
var crypto = window.crypto || window.msCrypto;
if(crypto && crypto.getRandomValues) {
  var priv = new Uint8Array(32);
  crypto.getRandomValues(priv);
  var priv_base58 = base58.enc(priv);
  var priv_dec = priv_base58.dec();
  var enc_err = 0;
  if(priv.length != priv_dec.length) {
    enc_err = 1;
  } else {
    for(var i in priv) {
      if(priv[i] != priv_dec[i]) {
        enc_err = 1;
        break;
      }
    }
  }
  if(enc_err) {
    throw new Error('base58 encode failed.');
  }

  var tags = new Uint8Array(6);
  crypto.getRandomValues(tags);
  var tag = "";
  for(var i in tags) {
    tag += base58_chars[tags[i] % 58]
  }
  var seedstr = 'seed:' + priv_base58 + ',tag:' + tag + ',gen:pastel-v0.1';
  document.getElementById('seed').innerHTML = seedstr;
  var canvas_s = 400;
  $('#qrcode').qrcode({
    render: 'canvas',
    ecLevel: 'Q',
    radius: 0.39,
    text: seedstr,
    size: canvas_s,
    mode: 2,
    label: 'seed',
    fontname: 'sans-serif',
    fontcolor: '#393939'
  });

  var pt_ratio = 72 / 25.4;
  var card_layouts = [
    {
      name: 'layout type 1 (landscape)',
      name_short: 'layout1',
      width: 148,
      height: 100,
      card: {
        width: 54,
        height: 86,
        margin_x: 2,
        margin_y: 2,
        round: 3
      },
      card_positions: [{x: 10, y: 7}, {x: 10 + 54 + 20, y: 7}]
    },
    {
      name: 'layout type 2 (landscape)',
      name_short: 'layout2',
      width: 148.5,
      height: 100,
      card: {
        width: 54,
        height: 85.6,
        margin_x: 2,
        margin_y: 2,
        round: 3
      },
      card_positions: [{x: 18, y: 7.2}, {x: 18 + 54 + 4.5, y: 7.2}]
    }
  ];

  function downloadPdf(settings) {
    var layout = settings.layout;
    var printable = settings.printable;
    var w = layout.width * pt_ratio;
    var h = layout.height * pt_ratio;
    var landscape = (w > h);
    var pdf = new jsPDF({
      orientation: landscape ? 'l' : 'p',
      unit: 'pt',
      format: [landscape ? h : w, landscape ? w : h]
    });
    pdf.addFont('RobotoMono-Bold.ttf', 'RobotoMono-Bold', 'bold');
    pdf.setProperties({
      title: 'Seed Card',
      subject: 'Generated seed card for cryptocurrency wallets',
      author: 'zenywallet',
      keywords: 'seed, maker, generator, cryptocurrency, wallet',
      creator: 'Seed Maker'
    });
    var s = Math.ceil(priv_base58.length / 2);
    var upper = priv_base58.substring(0, s);
    var lower = priv_base58.substring(s);
    var upper_tmp = '';
    var lower_tmp = '';
    for(var i = 0; i < upper.length; i += 4) {
      upper_tmp += upper.substr(i, 4) + ' ';
    }
    for(var i = 0; i < lower.length; i += 4) {
      lower_tmp += lower.substr(i, 4) + ' ';
    }
    upper_tmp = upper_tmp.trim();
    if(upper_tmp.length < lower_tmp.length) {
      lower_tmp = lower_tmp.trim();
    }
    upper = upper_tmp;
    lower = lower_tmp;

    // all page area
    if(!printable) {
      pdf.setFillColor(255, 255, 200);
      pdf.rect(0, 0, w, h, 'F');
    }

    // card area
    var card_w = layout.card.width * pt_ratio;
    var card_h = layout.card.height * pt_ratio;
    var card_margin_x = layout.card.margin_x * pt_ratio;
    var card_margin_y = layout.card.margin_y * pt_ratio;
    var card_round = layout.card.round * pt_ratio;
    for(var i in layout.card_positions) {
      var pos = layout.card_positions[i];
      var x = pos.x * pt_ratio;
      var y = pos.y * pt_ratio;

      if(!printable) {
        // card margin
        pdf.setFillColor(200, 200, 200);
        pdf.rect(x - card_margin_x, y - card_margin_y,
                card_w + card_margin_x * 2, card_h + card_margin_y * 2, 'F');

        // card body
        pdf.setFillColor(255, 255, 255);
        pdf.roundedRect(x, y, card_w, card_h, card_round, card_round, 'F');
      }

      // card info area
      pdf.setFillColor(230, 230, 230);
      if(printable) {
        pdf.rect(x - card_margin_x, card_w + y,
                card_w + card_margin_x * 2, Math.abs(card_h - card_w) + card_margin_x, 'F');
      } else {
        pdf.rect(x, card_w + y, card_w, card_round, 'F');
        pdf.roundedRect(x, card_w + y, card_w, Math.abs(card_h - card_w), card_round, card_round, 'F');
      }

      // QR
      var qr_margin = 4 * pt_ratio;
      var svg_s = (card_w < card_h ? card_w : card_h) - qr_margin * 2;
      $('<div></div>').qrcode({
        render: 'canvas',
        renderContext: pdf.context2d,
        left: (x + qr_margin),
        top: (y + qr_margin),
        ecLevel: 'Q',
        radius: 0.39,
        text: seedstr,
        size: svg_s,
        mode: 2,
        label: '             ',
        mSize: 0.05,
        fontname: 'sans-serif',
        fontcolor: '#393939'
      });

      pdf.setFont('RobotoMono-Bold');
      pdf.setFontSize(12);
      pdf.setTextColor(117, 117, 117);
      var center_x = x + card_w / 2;
      pdf.text(center_x, y + card_w / 2 + 4, 'Seed', null, null, 'center');

      pdf.setTextColor(87, 87, 87);
      pdf.text(x + qr_margin, y + card_w + 2 * pt_ratio + 10, 'Seed');
      pdf.setFontSize(6);
      pdf.text(x + qr_margin, y + card_w + 2 * pt_ratio + 18, 'pastel-v0.1');

      pdf.setFontSize(8);
      pdf.text(center_x, y + card_w + 2 * pt_ratio + 38, upper, null, null, 'center');
      pdf.text(center_x, y + card_w + 2 * pt_ratio + 54, lower, null, null, 'center');

      // tag background
      var tag_x = x + card_w - 15 * pt_ratio;
      var tag_y = y + card_w + 2 * pt_ratio;
      var ctx = pdf.context2d;
      ctx.fillStyle = 'rgb(250,250,250)';
      ctx.strokeStyle = 'rgb(250,250,250)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(tag_x, tag_y);
      ctx.lineTo(tag_x - 7, tag_y + 6);
      ctx.lineTo(tag_x, tag_y + 12);
      ctx.lineTo(tag_x + 32, tag_y + 12);
      ctx.lineTo(tag_x + 32, tag_y);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
      pdf.setFillColor(250, 250, 250);
      pdf.setDrawColor(250, 250, 250);
      pdf.roundedRect(tag_x + 32 - 2, tag_y, 4, 12, 2, 2, 'FD');
      pdf.setFillColor(230, 230, 230);
      pdf.roundedRect(tag_x - 3, tag_y + 4.5, 3, 3, 3, 3, 'F');

      // tag text
      pdf.setTextColor(87, 87, 87);
      pdf.setFontSize(7);
      pdf.text(x + card_w - qr_margin - 1, y + card_w + 2 * pt_ratio + 8.2, tag, null, null, 'right');

      // seed vector, memo area
      pdf.setFillColor(250, 250, 250);
      pdf.setDrawColor(250, 250, 250);
      pdf.roundedRect(x + 2 * pt_ratio + 1, y + card_w + (2 + 28) * pt_ratio - 13,
                    card_w - (2 * pt_ratio + 1) * 2, 12, 3, 3, 'FD');

    }

    pdf.viewerPreferences({'FitWindow': true}, true);
    preview_iframe.src = pdf.output('datauristring');
    pdf.save('seedcard-' + tag + '-' + layout.name_short + (printable ? '-printable' : '') + '.pdf');
  }

  var btn_download_type1 = document.getElementById('btn-download-type1');
  btn_download_type1.addEventListener('click', function() {
    downloadPdf({layout: card_layouts[0], printable: document.form.printable.checked});
  });
  var btn_download_type2 = document.getElementById('btn-download-type2');
  btn_download_type2.addEventListener('click', function() {
    downloadPdf({layout: card_layouts[1], printable: document.form.printable.checked});
  });

} else {
  throw new Error('Secure random number generation is not supported by this browser.');
}
</script>
</body>
</html>
