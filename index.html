<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="js/jquery-3.4.1.slim.min.js"></script>
  <script type="text/javascript" src="js/canvas2svg.js"></script>
  <script type="text/javascript" src="js/jquery-qrcode.js"></script>
  <script type="text/javascript" src="js/base58.js"></script>
  <script type="text/javascript" src="js/jspdf.min.js"></script>
  <script type="text/javascript" src="js/svg2pdf.min.js"></script>
  <title>Seed Maker</title>
</head>
<body>
<div id="qrcode"></div>
<div id="qrcode-svg"></div>
<div id="seed"></div>
<button id="btn-download-pdf">Download PDF</button>
<script>
var crypto = window.crypto || window.msCrypto;
if(crypto && crypto.getRandomValues) {
  var priv = new Uint8Array(32);
  crypto.getRandomValues(priv);
  var priv_base58 = base58.enc(priv);
  var priv_dec = priv_base58.dec();
  var enc_err = 0;
  if(priv.length != priv_dec.length) {
    enc_err = 1;
  } else {
    for(var i in priv) {
      if(priv[i] != priv_dec[i]) {
        enc_err = 1;
        break;
      }
    }
  }
  if(enc_err) {
    throw new Error('base58 encode failed.');
  }

  var tags = new Uint8Array(6);
  crypto.getRandomValues(tags);
  var tag = "";
  for(var i in tags) {
    tag += base58_chars[tags[i] % 58]
  }
  var seedstr = 'seed:' + priv_base58 + ',tag:' + tag + ',gen:pastel-v0.1';
  document.getElementById('seed').innerHTML = seedstr;
  var canvas_s = 400;
  $('#qrcode').qrcode({
    render: 'canvas',
    ecLevel: 'Q',
    radius: 0.39,
    text: seedstr,
    size: canvas_s,
    mode: 2,
    label: 'seed',
    fontname: 'sans-serif',
    fontcolor: '#393939'
  });

  $('#qrcode-svg').hide();
  var qr_margin = 4;
  var svg_s = (54 - qr_margin * 2) * 72 / 25.4;
  $('#qrcode-svg').qrcode({
    render: 'svg',
    ecLevel: 'Q',
    radius: 0.39,
    text: seedstr,
    size: svg_s,
    mode: 2,
    label: '             ',
    mSize: 0.05,
    fontname: 'sans-serif',
    fontcolor: '#393939'
  });

  function downloadPdf() {
    var k = 72 / 25.4;
    var pdf = new jsPDF({
      orientation: 'l',
      unit: 'pt',
      format: [100 * k, 148 * k]
    });

    //console.log(pdf.getFontList());

    //pdf.addFont('courier', 'normal');
    pdf.setFont('courier');
    pdf.setFontType("bold");

    pdf.setFillColor(255,255,200);
    pdf.rect(0, 0, 148 * k, 100 * k, 'F');
    pdf.setFillColor(200,200,200);
    var margin_x = 2 * k;
    var margin_y = 2 * k;
    pdf.rect(10 * k - margin_x, 7 * k - margin_y, 54 * k + 2 * margin_x, 86 * k + 2 * margin_y, 'F');
    pdf.rect(84 * k - margin_x, 7 * k - margin_y, 54 * k + 2 * margin_x, 86 * k + 2 * margin_y, 'F');
    pdf.setFillColor(255,255,255);
    pdf.roundedRect(10 * k, 7 * k, 54 * k, 86 * k, 3 * k, 3 * k, 'F');
    pdf.roundedRect(84 * k, 7 * k, 54 * k, 86 * k, 3 * k, 3 * k, 'F');
    pdf.setFillColor(230,230,230);
    pdf.rect(10 * k, (7 + 54) * k, 54 * k, 4 * k, 'F');
    pdf.roundedRect((10) * k, (7 + 54) * k, (54) * k, 32 * k, 3 * k, 3 * k, 'F');

    var svgobj = document.getElementById('qrcode-svg').firstChild;
    svg2pdf(svgobj, pdf, {
      xOffset: 10 * k + qr_margin * k,
      yOffset: 7 * k + qr_margin * k,
      scale: 1
    });

    pdf.setFontSize(12);
    pdf.setTextColor(117,117,117);
    pdf.text((10 + 54 / 2) * k, (7 + 54 / 2) * k + 4,'Seed', null, null, 'center');

    pdf.setTextColor(87,87,87);
    pdf.text((10 + 4) * k, (7 + 54 + 2) * k + 10, 'Seed');
    pdf.setFontSize(6);
    pdf.text((10 + 4) * k, (7 + 54 + 2) * k + 18, 'pastel-v0.1');

    var s = Math.ceil(priv_base58.length / 2);
    var upper = priv_base58.substring(0, s);
    var lower = priv_base58.substring(s);
    console.log(upper);
    console.log(lower);
    var upper2 = '';
    var lower2 = '';
    for(var i = 0; i < upper.length; i += 4) {
      upper2 += upper.substr(i, 4) + ' ';
    }
    for(var i = 0; i < lower.length; i += 4) {
      lower2 += lower.substr(i, 4) + ' ';
    }
    upper2 = upper2.trim();
    if(upper2.length < lower2.length) {
      lower2 = lower2.trim();
    }
    pdf.setFontSize(8);
    pdf.text((10 + 54 / 2) * k, (7 + 54 + 2) * k + 38, upper2, null, null, 'center');
    pdf.text((10 + 54 / 2) * k, (7 + 54 + 2) * k + 54, lower2, null, null, 'center');
    var tag_x = 49 * k;
    var tag_y = 63 * k;
    var ctx = pdf.context2d;
    ctx.fillStyle = 'rgb(250,250,250)';
    ctx.strokeStyle = 'rgb(250,250,250)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(tag_x, tag_y);
    ctx.lineTo(tag_x - 7, tag_y + 6);
    ctx.lineTo(tag_x, tag_y + 12);
    ctx.lineTo(tag_x + 32, tag_y + 12);
    ctx.lineTo(tag_x + 32, tag_y);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    pdf.setFillColor(250,250,250);
    pdf.setDrawColor(250,250,250);
    pdf.roundedRect(tag_x + 32 - 2, tag_y, 4, 12, 2, 2, 'FD');
    pdf.setFillColor(230,230,230);
    pdf.roundedRect(tag_x - 3, tag_y + 4.5, 3, 3, 3, 3, 'F');

    pdf.setTextColor(87,87,87);
    pdf.setFontSize(7);
    pdf.text((10 + 54 - 4) * k - 1, (7 + 54 + 2) * k + 8.2, tag, null, null, 'right');

    pdf.setFillColor(250,250,250);
    pdf.setDrawColor(250,250,250);
    pdf.roundedRect((10 + 4 - 2) * k + 1, (7 + 54 + 2 + 28) * k - 13, (54 - 8 + 4) * k - 2, 12, 3, 3, 'FD');

    pdf.viewerPreferences({'FitWindow': true}, true);
    pdf.save('seedcard-' + tag + '.pdf');
  }

  var btn_download_pdf = document.getElementById('btn-download-pdf');
  btn_download_pdf.addEventListener('click', function() {
    downloadPdf();
  });

} else {
  throw new Error('Secure random number generation is not supported by this browser.');
}
</script>
</body>
</html>
